<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>In-Network Aggregation for Shared Machine Learning Clusters</title><link rel=stylesheet href=https://www.bodunhu.com/blog/css/colors-preference.min.3cad5cfce31e6a95813c53ca957b3374369ebc4ad8bfe4e93c5f14e7c871efc5.css><link rel="shortcut icon" href=https://www.bodunhu.com/blog/favicon.ico><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js async></script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-108144808-1","auto"),ga("send","pageview"))</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-108144808-1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><header id=header><h1><a href=https://www.bodunhu.com/blog/>std::bodun::blog</a></h1><p>PhD student at University of Texas at Austin ðŸ¤˜. Doing systems for ML.</p></header><div id=page><div id=sidebar><nav><ul class=nav><li><a href=/blog/posts/><span>Archive</span></a></li><li><a href=https://www.bodunhu.com/><span>About</span></a></li><li><a href=/blog/index.xml><span>Feed</span></a></li></ul></nav></div><div id=content><article class=post><h1><a href=https://www.bodunhu.com/blog/posts/in-network-aggregation-for-shared-machine-learning-clusters/>In-Network Aggregation for Shared Machine Learning Clusters</a></h1><div class=post-content><p>This <a href=https://proceedings.mlsys.org/paper/2021/file/eae27d77ca20db309e056e3d2dcd7d69-Paper.pdf>paper</a> by Nadeen appeared in MLSys 2021. It presents an in-network aggregation framework called <em>PANAMA</em> for distributed ML training tasks. <em>PANAMA</em> has two components: (1) an in-network hardware accelerator with support for floating-point gradient aggregation; (2) a domain-specific load-balancing and congestion control protocol.</p><h2 id=motivation>Motivation</h2><p>The primary motivation behind <em>PANAMA</em> is the <em>data-parallel</em> training (in which the neural network is replicated across \(N\) worker where each worker processes a subset of the training data) demands constant local gradient exchanging at every iteration, thus creating a huge amount of traffic.</p><p>For example, for a training job with \(1000\) workers and 1 GB DNN model size requring \(1000\) iterations, the total traffic will be about 2 PB.</p><p><img src=https://cdn.jsdelivr.net/gh/BDHU/Page_Pics/posts/in-network-aggregation-for-shared-machine-learning-clusters/network-flow-size.png#center alt=in-network-aggregation-traffic></p><h2 id=network-design>Network Design</h2><p>The paper assumes a traditional data center multi-tier folded <a href=https://en.wikipedia.org/wiki/Clos_network>Clos topology</a>:</p><p><img src=https://cdn.jsdelivr.net/gh/BDHU/Page_Pics/posts/in-network-aggregation-for-shared-machine-learning-clusters/clos.png#center alt=clos-topology></p><p><em>PANAMA</em> uses multiple aggregation trees per training job to spread the traffic across multiple paths and avoid congestion hotspots. This is different to equal-cost multi-path (ECMP) protocol because the aggregation flows are typically large. Bounding such flows to a single aggregation tree will create network imbalance.</p><h2 id=congestion-control>Congestion Control</h2><p><em>PANAMA</em> uses <strong>implicit acknowledgments</strong> instead of traditional point-to-point approaches. Because each aggregated packets are constructed on the fly, one-to-one mapping between packets and the acknowledgements is unnecessary, if a worker receives aggregation results, that automatically serves as an <em>implicit</em> acknowledgement. This eliminated the need to keep a per-flow congestion state at PSwitches.</p><p>Similar to <a href>DCTCP</a>, <em>PANAMA</em> relies on ECN marks in the IP header to react to the network congestion. Since aggregation packets are created on the switch, each hardware accelerator need to perform a bitwise \(OR\) on the ECN field of received packets to mirror the traditional ECN bit.</p><h2 id=hardware-design>Hardware Design</h2><p>The design of the aggregation accelerator in <em>PANAMA</em> is straightforward: it utilized the SIMD architecture in which the gradients are partitioned across adder trees. Adder tree can operate in parallel and pack the results and sent them to the output ports. The VID fields are merely used to correct aggregation.</p><p><img src=https://cdn.jsdelivr.net/gh/BDHU/Page_Pics/posts/in-network-aggregation-for-shared-machine-learning-clusters/aggregater-arch.png#center alt=aggregator-arch></p><p>Overall, the workflow is really simple and illustrated below:</p><p><img src=https://cdn.jsdelivr.net/gh/BDHU/Page_Pics/posts/in-network-aggregation-for-shared-machine-learning-clusters/network-aggregation-workflow.png alt=network-aggregation-workflow></p></div><p class=meta>Posted on <span class=postdate>31. August 2021</span></p></article></div><footer id=footer><p class=copyright><p>Â© 2022 <a href=https://www.bodunhu.com>Bodun Hu</a>. All rights reserved.</p></p></footer></div></body></html>